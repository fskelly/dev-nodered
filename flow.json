[{"id":"6e4e7309.81165c","type":"tab","label":"Google API Testing","disabled":false,"info":""},{"id":"247a7db4.488d62","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"690339e0.145a08","type":"tab","label":"Owntracks Tracker","disabled":false,"info":""},{"id":"eddcae95.aa2d6","type":"tab","label":"Flow 2","disabled":false,"info":""},{"id":"15c157a1.27c788","type":"tab","label":"Alexa Testing","disabled":false,"info":""},{"id":"95334549.408f08","type":"tab","label":"Presence Detection","disabled":true,"info":""},{"id":"d58c58f8.8219f8","type":"tab","label":"Telemetry","disabled":true,"info":""},{"id":"8c52d380.fec46","type":"tab","label":"Sample Playpen","disabled":false,"info":""},{"id":"a7fe27bd.2509f8","type":"tab","label":"Life360 Tracker","disabled":false,"info":""},{"id":"b9fe7189.3c263","type":"tab","label":"House Telemetry","disabled":false,"info":""},{"id":"f119fad.23edf08","type":"tab","label":"Testing","disabled":false,"info":""},{"id":"d90740e8.853308","type":"tab","label":"DEV - Data Collection","disabled":false,"info":""},{"id":"109d456b.a1bf5b","type":"tab","label":"Flow 4","disabled":false,"info":""},{"id":"91cd2d0c.f8d9","type":"tab","label":"Flow 3","disabled":false,"info":""},{"id":"9e4fefba.e2b33","type":"tab","label":"sonoff control","disabled":false,"info":""},{"id":"8c3854a8.1ec5c8","type":"subflow","name":"Startup Delay","info":"","category":"","in":[{"x":60,"y":120,"wires":[{"id":"9b33cb8d.70f6c8"}]}],"out":[{"x":480,"y":120,"wires":[{"id":"3b4abb08.ef19e4","port":0}]}]},{"id":"f27aa045.98e9d","type":"subflow","name":"Alexa Messages","info":"","category":"Notifications","in":[{"x":200,"y":140,"wires":[{"id":"aa993341.a2e07"}]}],"out":[],"env":[],"status":{"x":160,"y":30,"wires":[]}},{"id":"66726911.b76f98","type":"mqtt-broker","z":"","name":"Mosquitto - Whale","broker":"192.168.1.41","port":"1883","clientid":"Node-RED-Dev","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"abc5f2b.6bde21","type":"server","z":"","name":"Home Assistant - DeathStar","legacy":false,"hassio":false,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true},{"id":"6eb36010.171f5","type":"mqtt-broker","z":"","name":"unRaid-MQTT","broker":"192.168.1.4","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"beb2d5b5.e9a6f8","type":"influxdb","z":"","hostname":"192.168.1.4","port":"8086","protocol":"http","database":"telemetry","name":"","usetls":false,"tls":""},{"id":"60641eba.4e311","type":"mongodb","z":"d58c58f8.8219f8","hostname":"192.168.1.4","port":"27017","db":"node-red","name":""},{"id":"c66a5642.c17e98","type":"server","z":"","name":"Home Assistant - 8124","legacy":false,"hassio":false,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true},{"id":"16ebb146.299d6f","type":"mqtt-broker","z":"","name":"orca-dev-mqtt","broker":"192.168.1.43","port":"21883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"39e7b6cc.400702","type":"mongodb","z":"","hostname":"192.168.1.43","port":"37017","db":"node-red","name":""},{"id":"87bc6ced.c12878","type":"influxdb","z":"","hostname":"192.168.1.4","port":"8086","protocol":"http","database":"telemetry","name":"","usetls":false,"tls":""},{"id":"e613cf86.3feb98","type":"influxdb","z":"","hostname":"192.168.1.4","port":"8086","protocol":"http","database":"dev_weather","name":"dev_weather","usetls":false,"tls":""},{"id":"b08dc7ea.aabfd","type":"influxdb","z":"","hostname":"192.168.1.43","port":"28086","protocol":"http","database":"sensortelemetry","name":"","usetls":false,"tls":""},{"id":"c6bdf57c.59baa8","type":"mqtt-broker","z":"","name":"192.168.1.159","broker":"192.168.1.159","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"a3722ee8.c88ce","type":"server","z":"","name":"Orca - 8124","legacy":false,"hassio":false,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true},{"id":"feb63a70.687138","type":"http request","z":"6e4e7309.81165c","name":"Karien Travel Time","method":"GET","ret":"obj","paytoqs":false,"url":"https://maps.googleapis.com/maps/api/distancematrix/json?origins=18+Forest+Drive+Lonehill&destinations=NetFlorist+Waterfall+Commercial+District+Midrand&key={{secret}}&mode=driving&traffic_model=pessimistic&departure_time=now","tls":"","proxy":"","authType":"","x":450,"y":140,"wires":[["8b6353a0.5542d"]]},{"id":"39bd73db.ff4c8c","type":"inject","z":"6e4e7309.81165c","name":"","topic":"1","payload":"test","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":70,"y":380,"wires":[["253083b6.febbcc","4dc3c2a9.9b28ec"]]},{"id":"b794425b.97b8b","type":"switch","z":"6e4e7309.81165c","name":"RAG scale","property":"payload","propertyType":"msg","rules":[{"t":"lte","v":"11","vt":"str"},{"t":"btwn","v":"12","vt":"str","v2":"20","v2t":"str"},{"t":"gte","v":"21","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1030,"y":220,"wires":[["7d2760d2.febd6"],["82631610.583b78"],["5ac48bb7.fde664"]]},{"id":"7d2760d2.febd6","type":"function","z":"6e4e7309.81165c","name":"kk - green","func":"msg.topic ='karien'\nmsg.payload = msg.topic + ' travel time is ' + msg.traveltime;\nmsg.mqtttopictext = 'tele/travel/' + msg.topic\nmsg.led = 'green'\nmsg.mqtttopicled = 'tele/travel/' + msg.topic + '/led/'\nreturn msg;","outputs":1,"noerr":0,"x":1280,"y":120,"wires":[["e6223a2b.130d28","f9a2bf40.e17e2"]]},{"id":"d7d6cc3a.f3411","type":"switch","z":"6e4e7309.81165c","name":"RAG scale","property":"payload","propertyType":"msg","rules":[{"t":"lte","v":"8","vt":"str"},{"t":"btwn","v":"9","vt":"str","v2":"12","v2t":"str"},{"t":"gte","v":"13","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1030,"y":340,"wires":[["80822b2b.0ebc18"],["ffbc4453.ac9408"],["30c8eb76.72fa54"]]},{"id":"75a3e0c8.9585b","type":"http request","z":"6e4e7309.81165c","name":"Fletcher Travel Time","method":"GET","ret":"obj","paytoqs":false,"url":"https://maps.googleapis.com/maps/api/distancematrix/json?origins=18+Forest+Drive+Lonehill&destinations=3012+william+Nicol+Drive+Bryanston&key={{secret}}&mode=driving&traffic_model=pessimistic&departure_time=now","tls":"","proxy":"","authType":"","x":420,"y":320,"wires":[["7ab08437.e641dc"]]},{"id":"3b4abb08.ef19e4","type":"switch","z":"8c3854a8.1ec5c8","name":"","property":"StartupDelay","propertyType":"global","rules":[{"t":"false"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":120,"wires":[[],["66ff4b09.c97e84"]]},{"id":"66ff4b09.c97e84","type":"delay","z":"8c3854a8.1ec5c8","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":180,"wires":[["3b4abb08.ef19e4"]]},{"id":"9b33cb8d.70f6c8","type":"delay","z":"8c3854a8.1ec5c8","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":180,"y":120,"wires":[["3b4abb08.ef19e4"]]},{"id":"d679ca69.a5eff8","type":"mqtt in","z":"247a7db4.488d62","name":"OwnTracks","topic":"owntracks/+/+","qos":"2","datatype":"auto","broker":"66726911.b76f98","x":100,"y":220,"wires":[["19de6bc8.135374"]]},{"id":"2456d521.b9e6fa","type":"json","z":"247a7db4.488d62","name":"","property":"payload","action":"","pretty":false,"x":410,"y":220,"wires":[["3a89732c.33e0dc"]]},{"id":"3a89732c.33e0dc","type":"function","z":"247a7db4.488d62","name":"Parse","func":"if (msg.payload._type === \"location\")\n{\n//    var date = new Date(parseInt(msg.payload.tst) * 1000);\n    \n    msg.payload.data = {\n        \"battery\" : parseInt(msg.payload.batt),\n        \"dev_id\" : msg.topic.replace(/\\/|-/g, \"_\").toLowerCase(),\n        \"gps\" : [parseFloat(msg.payload.lat),parseFloat(msg.payload.lon)],\n        \"gps_accuracy\" : msg.payload.acc\n    };\n    msg.timestamp = msg.payload.tst;\n}\nelse\n    msg = null;\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":220,"wires":[["168ca38f.8671fc"]]},{"id":"2f3f7007.462dd","type":"switch","z":"247a7db4.488d62","name":"At Home?","property":"location.inarea","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":780,"y":220,"wires":[["ed3c34.610fd3d"],["3662be20.6c7fc2","53657ae0.e1e554"]]},{"id":"3662be20.6c7fc2","type":"change","z":"247a7db4.488d62","name":"Home","rules":[{"t":"set","p":"payload.data.location_name","pt":"msg","to":"home","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":240,"wires":[["c0e92bed.0c7bd8","3aa1a5f6.11028a"]]},{"id":"ed3c34.610fd3d","type":"change","z":"247a7db4.488d62","name":"Away","rules":[{"t":"set","p":"payload.data.location_name","pt":"msg","to":"not_home","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":200,"wires":[["3aa1a5f6.11028a","c0e92bed.0c7bd8","d3c2f4af.3d9fc8"]]},{"id":"c0e92bed.0c7bd8","type":"debug","z":"247a7db4.488d62","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1070,"y":200,"wires":[]},{"id":"3aa1a5f6.11028a","type":"api-call-service","z":"247a7db4.488d62","name":"Update device_tracker","server":"","service_domain":"device_tracker","service":"see","data":"","mergecontext":"","x":1120,"y":240,"wires":[[]]},{"id":"19de6bc8.135374","type":"subflow:8c3854a8.1ec5c8","z":"247a7db4.488d62","name":"","env":[],"x":260,"y":220,"wires":[["2456d521.b9e6fa"]]},{"id":"53657ae0.e1e554","type":"api-current-state","z":"247a7db4.488d62","name":"Recent Door Activity?","server":"","outputs":1,"halt_if":"","override_topic":false,"entity_id":"input_boolean.door_activity","override_payload":true,"override_data":true,"x":940,"y":320,"wires":[["d72f7d3b.51632","1a2c4c63.6126f4"]]},{"id":"d72f7d3b.51632","type":"switch","z":"247a7db4.488d62","name":"On / Off","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":1140,"y":320,"wires":[["d3c2f4af.3d9fc8"],["7c4518f1.d4e128"]]},{"id":"d3c2f4af.3d9fc8","type":"function","z":"247a7db4.488d62","name":"OwnTracks variable","func":"distance = parseInt(msg.location.distances.Home);\ninterval = parseInt(0.000000000000475 * Math.pow(distance,4) - 0.00000000475 * Math.pow(distance,3) + 0.0000265 * Math.pow(distance,2) + 0.0037 * distance + 1.43);\ndev_id = msg.topic.replace(/\\/|-/g, \"_\").toLowerCase();\n\nif (interval < 3) interval = 3;\nif (interval > 300) interval = 300;\n\nlastInterval = flow.get(dev_id + '_last_owntracks_interval');\nlastTimestamp = flow.get(dev_id + '_last_owntracks_timestamp');\n\nvar temp = new Date(parseInt(msg.timestamp) * 1000);\nnode.status({fill: \"green\", shape: \"dot\", text: interval + \" at \" + temp.toLocaleString()});\n\nif (typeof(lastInterval) != \"undefined\")\n{\n\tif ((msg.timestamp - 3600) < lastTimestamp) // less than 1 hour since last update?\n\t{\n\t\tif (lastInterval > (interval / 1.05) && lastInterval < (interval * 1.05)) // within 5% of last update?\n        {\n            node.status({fill: \"red\", shape: \"ring\", text: interval + \" at \" + temp.toLocaleString()});\n            msg = null;\n        }\n        else\n\t\t{\n            node.status({fill: \"green\", shape: \"dot\", text: msg.timestamp + \" versus \" + lastTimestamp});\n            flow.set('_last_owntracks_interval', interval);\n            flow.set('_last_owntracks_timestamp', msg.timestamp);\n\n            msg.topic = msg.topic + \"/cmd\";\n            msg.payload = {\n                \"_type\" : \"cmd\",\n                \"action\" : \"setConfiguration\",\n                \"configuration\" : {\n                    \"_type\" : \"configuration\",\n                    \"beaconMode\" : 2,\n                    \"locatorDisplacement\" : interval * 2,\n                    \"locatorInterval\" : interval,\n                    \"pub\" : \"true\",\n                    \"pubQos\" : 2\n                }\n            };\n        }\n    }\n    else\n    {\n        flow.set(dev_id + '_last_owntracks_interval', interval);\n        flow.set(dev_id + '_last_owntracks_timestamp', msg.timestamp);\n\n        msg.topic = msg.topic + \"/cmd\";\n        msg.payload = {\n            \"_type\" : \"cmd\",\n            \"action\" : \"setConfiguration\",\n            \"configuration\" : {\n                \"_type\" : \"configuration\",\n                \"beaconMode\" : 2,\n                \"locatorDisplacement\" : interval * 2,\n                \"locatorInterval\" : interval,\n                \"pub\" : \"true\",\n                \"pubQos\" : 2\n            }\n        };\n    }\n}\nelse\n{\n    flow.set(dev_id + '_last_owntracks_interval', interval);\n    flow.set(dev_id + '_last_owntracks_timestamp', msg.timestamp);\n\n    msg.topic = msg.topic + \"/cmd\";\n    msg.payload = {\n        \"_type\" : \"cmd\",\n        \"action\" : \"setConfiguration\",\n        \"configuration\" : {\n            \"_type\" : \"configuration\",\n            \"beaconMode\" : 2,\n            \"locatorDisplacement\" : interval * 2,\n            \"locatorInterval\" : interval,\n            \"pub\" : \"true\",\n            \"pubQos\" : 2\n        }\n    };\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1330,"y":300,"wires":[["91909a7c.9cb358","7b34452e.482e8c"]]},{"id":"7c4518f1.d4e128","type":"function","z":"247a7db4.488d62","name":"OwnTracks 120sec","func":"var timestamp = new Date(parseInt(msg.timestamp) * 1000);\nnode.status({fill: \"green\", shape: \"dot\", text: 120 + \" at \" + timestamp.toLocaleString()});\ndev_id = msg.topic.replace(/\\/|-/g, \"_\").toLowerCase();\n\nflow.set(dev_id + '_last_owntracks_timestamp', msg.timestamp);\nflow.set(dev_id + '_last_owntracks_interval', 120);\n\nmsg.topic = msg.topic + \"/cmd\";\nmsg.payload = {\n    \"_type\" : \"cmd\",\n    \"action\" : \"setConfiguration\",\n    \"configuration\" : {\n        \"_type\" : \"configuration\",\n        \"beaconMode\" : 2,\n        \"locatorDisplacement\" : 50,\n        \"locatorInterval\" : 120,\n        \"pub\" : \"true\",\n        \"pubQos\" : 2\n    }\n};\n// beaconMode was 0\n\nreturn msg;","outputs":1,"noerr":0,"x":1330,"y":360,"wires":[["7b34452e.482e8c","91909a7c.9cb358"]]},{"id":"91909a7c.9cb358","type":"mqtt out","z":"247a7db4.488d62","name":"","topic":"","qos":"2","retain":"false","broker":"66726911.b76f98","x":1510,"y":340,"wires":[]},{"id":"7b34452e.482e8c","type":"debug","z":"247a7db4.488d62","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1510,"y":300,"wires":[]},{"id":"5025b575.b2191c","type":"comment","z":"247a7db4.488d62","name":"Note: override topic is OFF","info":"","x":930,"y":360,"wires":[]},{"id":"1a2c4c63.6126f4","type":"debug","z":"247a7db4.488d62","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1130,"y":360,"wires":[]},{"id":"168ca38f.8671fc","type":"geofence","z":"247a7db4.488d62","name":"Home","mode":"polyline","inside":"both","rad":0,"points":[{"latitude":0.470799056043745,"longitude":40.95746326446533},{"latitude":0.47222352757142,"longitude":40.95632600784302},{"latitude":0.4736796205139,"longitude":40.95759201049805},{"latitude":0.4736796205139,"longitude":40.96282768249512},{"latitude":0.47220770028812,"longitude":40.96387910842896},{"latitude":0.47083071131877,"longitude":40.96278476715088}],"centre":{},"x":650,"y":220,"wires":[["2f3f7007.462dd"]]},{"id":"28eff82f.ca78b8","type":"server-state-changed","z":"690339e0.145a08","name":"owntracks - fk_s9_2","server":"a3722ee8.c88ce","version":1,"entityidfilter":"device_tracker.fk_fsksg9","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":140,"y":220,"wires":[["fe3bbea7.0d5d6","9410eb33.646268"]]},{"id":"114de7e4.3e35a8","type":"debug","z":"690339e0.145a08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1090,"y":120,"wires":[]},{"id":"c7104eaf.bb384","type":"comment","z":"690339e0.145a08","name":"Track FK S9 OwnTracks","info":"","x":150,"y":180,"wires":[]},{"id":"9d234afc.ff0698","type":"secret","z":"eddcae95.aa2d6","name":"IFTTT API Key","x":400,"y":260,"wires":[["45c311e4.b3ef6"]]},{"id":"45c311e4.b3ef6","type":"template","z":"eddcae95.aa2d6","name":"Set msg.url","field":"url","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"https://maker.ifttt.com/trigger/doorbell/with/key/{{secret}}","x":510,"y":320,"wires":[["cd2b4da9.7683d","5c498709.f71758"]]},{"id":"5c498709.f71758","type":"http request","z":"eddcae95.aa2d6","name":"IFTTT","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","proxy":"","x":670,"y":340,"wires":[[]]},{"id":"cd2b4da9.7683d","type":"debug","z":"eddcae95.aa2d6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":300,"wires":[]},{"id":"eaef44f7.309e58","type":"inject","z":"eddcae95.aa2d6","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":280,"y":200,"wires":[["9d234afc.ff0698"]]},{"id":"2cc6e2d8.58622e","type":"switch","z":"690339e0.145a08","name":"==home, Check if state has actually changed","property":"data.old_state.state","propertyType":"msg","rules":[{"t":"neq","v":"data.new_state.state","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":810,"y":120,"wires":[["114de7e4.3e35a8"]]},{"id":"fe3bbea7.0d5d6","type":"switch","z":"690339e0.145a08","name":"Home? or Not Home?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"not_home","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":220,"wires":[["2cc6e2d8.58622e"],["e5e844b8.4a7478","545cbe7d.2f528"]]},{"id":"e5e844b8.4a7478","type":"switch","z":"690339e0.145a08","name":"==not_home, Check if state has actually changed","property":"data.old_state.state","propertyType":"msg","rules":[{"t":"neq","v":"data.new_state.state","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":810,"y":340,"wires":[["263a43f6.68bdfc"]]},{"id":"263a43f6.68bdfc","type":"debug","z":"690339e0.145a08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1110,"y":340,"wires":[]},{"id":"9410eb33.646268","type":"debug","z":"690339e0.145a08","name":"owntracks_status","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":370,"y":340,"wires":[]},{"id":"545cbe7d.2f528","type":"debug","z":"690339e0.145a08","name":"not_home_debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":220,"wires":[]},{"id":"363494c0.c247ac","type":"pushover","z":"6e4e7309.81165c","name":"","device":"","title":"Travel Time","priority":0,"sound":"","url":"","url_title":"","html":false,"x":1750,"y":240,"wires":[]},{"id":"80822b2b.0ebc18","type":"function","z":"6e4e7309.81165c","name":"fk - green","func":"msg.topic ='fletcher'\nmsg.payload = msg.topic + ' travel time is ' + msg.traveltime;\nmsg.mqtttopictext = 'tele/travel/' + msg.topic\nmsg.led = 'green'\nmsg.mqtttopicled = 'tele/travel/' + msg.topic + '/led/'\nreturn msg;","outputs":1,"noerr":0,"x":1280,"y":320,"wires":[["77e84e5f.cac4f","2c2befab.60d54"]]},{"id":"e78056ed.d2c348","type":"api-call-service","z":"15c157a1.27c788","name":"Alexa Plus - Fletcher is home","server":"abc5f2b.6bde21","version":1,"service_domain":"media_player","service":"alexa_tts","entityId":"media_player.fletcher_s_echo_plus","data":"{\"message\":\"{{payload.message}}\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":240,"wires":[[]]},{"id":"e09804ce.b2c8e8","type":"inject","z":"15c157a1.27c788","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":260,"wires":[["e811d255.7c29d","8727ab18.ed3a88"]]},{"id":"8727ab18.ed3a88","type":"function","z":"15c157a1.27c788","name":"create \"fletcher\" message","func":"var name = 'Fletcher';\n\nmsg.payload = { \n    message: name + ' is home',\n};\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":260,"wires":[[]]},{"id":"a317812d.8fab6","type":"api-call-service","z":"15c157a1.27c788","name":"Alexa Plus - Fletcher is home","server":"abc5f2b.6bde21","service_domain":"media_player","service":"alexa_tts","data":"{\"entity_id\":\"media_player.fletcher_s_echo_plus\",\"message\":\"{{payload.message}}\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":320,"wires":[[]]},{"id":"e811d255.7c29d","type":"function","z":"15c157a1.27c788","name":"create Karien Message","func":"var name = 'Karien';\nmsg.payload = { \n    message: 'Weclome home ' + name ,\n};\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":320,"wires":[[]]},{"id":"b3aa40d6.c99f9","type":"switch","z":"95334549.408f08","name":"HOME / NOT HOME","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"not_home","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":180,"wires":[["27c84a0d.495506"],["2db90c5e.f2e6c4"]],"outputLabels":["Fletcher",""]},{"id":"fc784599.17c248","type":"switch","z":"95334549.408f08","name":"HOME / NOT HOME","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"not_home","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":500,"wires":[["3b91f5b.b89f90a"],["63cb3cd9.29a4c4"]],"outputLabels":["Fletcher",null]},{"id":"8e13aa60.5dc868","type":"server-state-changed","z":"95334549.408f08","name":"karien-home-devicetracker","server":"abc5f2b.6bde21","version":1,"entityidfilter":"device_tracker.karien_s_s8","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":110,"y":500,"wires":[["fc784599.17c248"]]},{"id":"c0ae4fd.b6596b","type":"server-state-changed","z":"95334549.408f08","name":"fletcher-home-devicetracker","server":"abc5f2b.6bde21","version":1,"entityidfilter":"device_tracker.fletcher_s_s9","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":160,"y":80,"wires":[["b3aa40d6.c99f9","ba93698d.f96ba8"]]},{"id":"cb418d52.19d0d","type":"api-call-service","z":"95334549.408f08","name":"Alexa Plus - Karien is home","server":"abc5f2b.6bde21","service_domain":"media_player","service":"alexa_tts","data":"{\"entity_id\":\"media_player.fletcher_s_echo_plus\",\"message\":\"Welcome home babe!!\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1100,"y":440,"wires":[[]]},{"id":"8c367b1a.45e958","type":"api-call-service","z":"95334549.408f08","name":"Alexa Dot - Fletcher is home","server":"abc5f2b.6bde21","service_domain":"media_player","service":"alexa_tts","data":"{\"entity_id\":\" media_player.fletcher_s_echo_dot\",\"message\":\"{{payload.message}}\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1120,"y":140,"wires":[[]]},{"id":"694d285d.0cade8","type":"api-call-service","z":"95334549.408f08","name":"Alexa - Karien is home","server":"abc5f2b.6bde21","service_domain":"media_player","service":"alexa_tts","data":"{\"entity_id\":\" media_player.fletcher_s_echo_dot\",\"message\":\"Welcome home babe!!\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1080,"y":500,"wires":[[]]},{"id":"27c84a0d.495506","type":"function","z":"95334549.408f08","name":"create \"fletcher\" home message","func":"var name = 'Fletcher';\n\nmsg.payload = { \n    message: name + ' is home',\n};\nmsg.topic = 'Presence Tracker'\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":100,"wires":[["d387f597.672e18","8c367b1a.45e958","14d036c2.d8f819"]]},{"id":"d387f597.672e18","type":"api-call-service","z":"95334549.408f08","name":"Alexa Plus - Fletcher is home","server":"abc5f2b.6bde21","service_domain":"media_player","service":"alexa_tts","data":"{\"entity_id\":\"media_player.fletcher_s_echo_plus\",\"message\":\"{{payload.message}}\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1120,"y":80,"wires":[[]]},{"id":"2db90c5e.f2e6c4","type":"function","z":"95334549.408f08","name":"create \"fletcher\" away message","func":"var name = 'Fletcher';\n\nmsg.payload = { \n    message: name + ' is away',\n};\nmsg.topic = 'Presence Tracker'\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":340,"wires":[["14d036c2.d8f819"]]},{"id":"14d036c2.d8f819","type":"change","z":"95334549.408f08","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.message","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":280,"wires":[["6e9500b0.89b8"]]},{"id":"6e9500b0.89b8","type":"pushover","z":"95334549.408f08","name":"","device":"","title":"","priority":0,"sound":"","url":"","url_title":"","html":false,"x":1120,"y":280,"wires":[]},{"id":"131463a6.8be71c","type":"change","z":"95334549.408f08","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.message","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":580,"wires":[["8bae1578.74a698"]]},{"id":"8bae1578.74a698","type":"pushover","z":"95334549.408f08","name":"","device":"","title":"","priority":0,"sound":"","url":"","url_title":"","html":false,"x":1180,"y":580,"wires":[]},{"id":"3b91f5b.b89f90a","type":"function","z":"95334549.408f08","name":"create Karien Message","func":"var name = 'Karien';\nmsg.payload = { \n    message: 'Weclome home ' + name ,\n};\nmsg.topic = 'Presence Tracker'\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":440,"wires":[["131463a6.8be71c","cb418d52.19d0d","694d285d.0cade8"]]},{"id":"63cb3cd9.29a4c4","type":"function","z":"95334549.408f08","name":"create Karien away Message","func":"var name = 'Karien';\nmsg.payload = { \n    message: name + ' is away' ,\n};\nmsg.topic = 'Presence Tracker'\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":640,"wires":[["131463a6.8be71c"]]},{"id":"b0ff6576.7a4728","type":"inject","z":"15c157a1.27c788","name":"","topic":"node-red-tracker","payload":"Test from Node-red","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":120,"wires":[["f35c8f94.5f047"]]},{"id":"f35c8f94.5f047","type":"pushover","z":"15c157a1.27c788","name":"","device":"","title":"","priority":0,"sound":"","url":"","url_title":"","html":false,"x":580,"y":120,"wires":[]},{"id":"31618ae6.532246","type":"comment","z":"15c157a1.27c788","name":"Node-red-contrib-testing","info":"","x":130,"y":80,"wires":[]},{"id":"a7f1c5aa.7b4528","type":"comment","z":"15c157a1.27c788","name":"Alexa testing with Home Assistant service","info":"","x":180,"y":220,"wires":[]},{"id":"253083b6.febbcc","type":"secret","z":"6e4e7309.81165c","name":"secret","x":250,"y":180,"wires":[["feb63a70.687138"]]},{"id":"d60ca853.67e678","type":"mqtt out","z":"6e4e7309.81165c","name":"whale - MQTT","topic":"","qos":"","retain":"","broker":"66726911.b76f98","x":1780,"y":120,"wires":[]},{"id":"e6223a2b.130d28","type":"change","z":"6e4e7309.81165c","name":"Travel Time Text","rules":[{"t":"set","p":"topic","pt":"msg","to":"mqtttopictext","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1500,"y":120,"wires":[["d60ca853.67e678","132ac459.9fd4bc","363494c0.c247ac"]]},{"id":"77e84e5f.cac4f","type":"change","z":"6e4e7309.81165c","name":"Travel Time Text","rules":[{"t":"set","p":"topic","pt":"msg","to":"mqtttopictext","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1500,"y":320,"wires":[["4926198c.c16bc8","858d37e.2dbe8c8","363494c0.c247ac"]]},{"id":"4926198c.c16bc8","type":"mqtt out","z":"6e4e7309.81165c","name":"whale - mqtt","topic":"","qos":"","retain":"","broker":"66726911.b76f98","x":1750,"y":320,"wires":[]},{"id":"82631610.583b78","type":"function","z":"6e4e7309.81165c","name":"kk - amber","func":"msg.topic ='karien'\nmsg.payload = msg.topic + ' travel time is ' + msg.traveltime;\nmsg.mqtttopictext = 'tele/travel/' + msg.topic\nmsg.led = 'amber'\nmsg.mqtttopicled = 'tele/travel/' + msg.topic + '/led/'\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":180,"wires":[["e6223a2b.130d28","f9a2bf40.e17e2"]]},{"id":"5ac48bb7.fde664","type":"function","z":"6e4e7309.81165c","name":"kk - red","func":"msg.topic ='karien'\nmsg.payload = msg.topic + ' travel time is ' + msg.traveltime;\nmsg.mqtttopictext = 'tele/travel/' + msg.topic\nmsg.led = 'red'\nmsg.mqtttopicled = 'tele/travel/' + msg.topic + '/led/'\nreturn msg;","outputs":1,"noerr":0,"x":1280,"y":240,"wires":[["f9a2bf40.e17e2","e6223a2b.130d28"]]},{"id":"f9a2bf40.e17e2","type":"change","z":"6e4e7309.81165c","name":"Travel Time Color","rules":[{"t":"set","p":"topic","pt":"msg","to":"mqtttopicled","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"led","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1510,"y":240,"wires":[["d60ca853.67e678","132ac459.9fd4bc"]]},{"id":"ffbc4453.ac9408","type":"function","z":"6e4e7309.81165c","name":"fk - amber","func":"msg.topic ='fletcher'\nmsg.payload = msg.topic + ' travel time is ' + msg.traveltime;\nmsg.mqtttopictext = 'tele/travel/' + msg.topic\nmsg.led = 'amber'\nmsg.mqtttopicled = 'tele/travel/' + msg.topic + '/led/'\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":380,"wires":[["77e84e5f.cac4f","2c2befab.60d54"]]},{"id":"30c8eb76.72fa54","type":"function","z":"6e4e7309.81165c","name":"fk - red","func":"msg.topic =' fletcher'\nmsg.payload = msg.topic + ' travel time is ' + msg.traveltime;\nmsg.mqtttopictext = 'tele/travel/' + msg.topic\nmsg.led = 'red'\nmsg.mqtttopicled = 'tele/travel/' + msg.topic + '/led/'\nreturn msg;","outputs":1,"noerr":0,"x":1280,"y":440,"wires":[["77e84e5f.cac4f","2c2befab.60d54"]]},{"id":"2c2befab.60d54","type":"change","z":"6e4e7309.81165c","name":"Travel Time Color","rules":[{"t":"set","p":"topic","pt":"msg","to":"mqtttopicled","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"led","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1510,"y":440,"wires":[["4926198c.c16bc8","858d37e.2dbe8c8"]]},{"id":"7dc1bb08.e935f4","type":"mqtt in","z":"d58c58f8.8219f8","name":"MXChip Telemetry","topic":"tele/mxchip1/#","qos":"0","datatype":"json","broker":"6eb36010.171f5","x":250,"y":360,"wires":[["5b55320.6d00bd","6c425fbc.46415"]]},{"id":"b42e1599.015548","type":"comment","z":"d58c58f8.8219f8","name":"MQTT -> Node-Red -> mongoDB","info":"","x":270,"y":300,"wires":[]},{"id":"6c425fbc.46415","type":"switch","z":"d58c58f8.8219f8","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"tele/mxchip1/temp","vt":"str"},{"t":"eq","v":"tele/mxchip1/humidity","vt":"str"},{"t":"eq","v":"pressure","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":580,"y":400,"wires":[["d06cae10.30a38"],["67c4d1b8.6d37a"],[]]},{"id":"d06cae10.30a38","type":"function","z":"d58c58f8.8219f8","name":"format for influx - temperature","func":"msg.payload ={\n    locale: \"Breakfast-Nook\",\n    temperature: parseFloat(msg.payload)\n}\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":380,"wires":[["cf8492f0.89e8a"]]},{"id":"67c4d1b8.6d37a","type":"function","z":"d58c58f8.8219f8","name":"format for influx - humidity","func":"msg.payload ={\n    locale: \"Breakfast-Nook\",\n    humidity: parseFloat(msg.payload)\n}\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":440,"wires":[["f337d8b6.fc67e8"]]},{"id":"cf8492f0.89e8a","type":"influxdb out","z":"d58c58f8.8219f8","influxdb":"beb2d5b5.e9a6f8","name":"influx insert","measurement":"temperature","precision":"","retentionPolicy":"","x":1210,"y":320,"wires":[]},{"id":"f337d8b6.fc67e8","type":"influxdb out","z":"d58c58f8.8219f8","influxdb":"beb2d5b5.e9a6f8","name":"influx insert","measurement":"humidity","precision":"","retentionPolicy":"","x":1210,"y":480,"wires":[]},{"id":"5b55320.6d00bd","type":"mongodb out","z":"d58c58f8.8219f8","mongodb":"60641eba.4e311","name":"","collection":"MXChip","payonly":false,"upsert":false,"multi":false,"operation":"insert","x":920,"y":260,"wires":[]},{"id":"bbd4df20.427f","type":"http in","z":"6e4e7309.81165c","name":"","url":"/karientraffic","method":"get","upload":false,"swaggerDoc":"","x":110,"y":100,"wires":[["253083b6.febbcc"]]},{"id":"7ab08437.e641dc","type":"change","z":"6e4e7309.81165c","name":"duration in traffic to traveltime","rules":[{"t":"set","p":"traveltime","pt":"msg","to":"payload.rows[0].elements[0].duration_in_traffic.text","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":320,"wires":[["b55b4d25.80e9c"]]},{"id":"bffb20b4.e6fdd","type":"inject","z":"8c52d380.fec46","name":"","topic":"","payload":"+CSIM: 201,\"90CC715D02E87B9BF513.....\"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":290,"y":400,"wires":[["4bd8caf1.9667a4"]]},{"id":"4bd8caf1.9667a4","type":"function","z":"8c52d380.fec46","name":"Extract bit in quotes","func":"var part = msg.payload.split(\" \")[0];\nmsg.payload = part;\nreturn msg;","outputs":1,"noerr":0,"x":493.5,"y":399,"wires":[["b674c484.f834b8","c06e9451.771448"]]},{"id":"b674c484.f834b8","type":"debug","z":"8c52d380.fec46","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":724,"y":398,"wires":[]},{"id":"1bc23905.c2a187","type":"inject","z":"8c52d380.fec46","name":"","topic":"","payload":"16 mins","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":290,"y":320,"wires":[["4bd8caf1.9667a4"]]},{"id":"b55b4d25.80e9c","type":"function","z":"6e4e7309.81165c","name":"Extract bit in quotes","func":"var part = msg.traveltime.split(\" \")[0];\nmsg.payload = part;\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":480,"wires":[["49727091.39b16"]]},{"id":"5ded3759.4b0b58","type":"inject","z":"8c52d380.fec46","name":"","topic":"","payload":"+CSIM: 201,\"90CC715D02E87B9BF513.....\"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":310,"y":580,"wires":[["e53d6db7.21953"]]},{"id":"e53d6db7.21953","type":"function","z":"8c52d380.fec46","name":"Extract bit in quotes","func":"var part = msg.payload.split(\"\\\"\")[1];\nmsg.payload = part;\nreturn msg;","outputs":1,"noerr":0,"x":513.5,"y":579,"wires":[["6d23d1ac.7a8a5"]]},{"id":"6d23d1ac.7a8a5","type":"debug","z":"8c52d380.fec46","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":744,"y":578,"wires":[]},{"id":"c06e9451.771448","type":"change","z":"8c52d380.fec46","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"$number(payload)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":280,"wires":[["bdb4337.db257d"]]},{"id":"bdb4337.db257d","type":"debug","z":"8c52d380.fec46","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":970,"y":280,"wires":[]},{"id":"49727091.39b16","type":"change","z":"6e4e7309.81165c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"$number(payload)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":480,"wires":[["d7d6cc3a.f3411"]]},{"id":"8b6353a0.5542d","type":"change","z":"6e4e7309.81165c","name":"duration in traffic to traveltime","rules":[{"t":"set","p":"traveltime","pt":"msg","to":"payload.rows[0].elements[0].duration_in_traffic.text","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":140,"wires":[["18f34b20.314c25"]]},{"id":"18f34b20.314c25","type":"function","z":"6e4e7309.81165c","name":"Extract bit in quotes","func":"var part = msg.traveltime.split(\" \")[0];\nmsg.payload = part;\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":60,"wires":[["4446730.a42858c"]]},{"id":"4446730.a42858c","type":"change","z":"6e4e7309.81165c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"$number(payload)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":60,"wires":[["b794425b.97b8b"]]},{"id":"132ac459.9fd4bc","type":"mqtt out","z":"6e4e7309.81165c","name":"unraid - mqtt","topic":"","qos":"","retain":"","broker":"6eb36010.171f5","x":1750,"y":180,"wires":[]},{"id":"858d37e.2dbe8c8","type":"mqtt out","z":"6e4e7309.81165c","name":"unraid - mqtt","topic":"","qos":"","retain":"","broker":"6eb36010.171f5","x":1770,"y":420,"wires":[]},{"id":"46e79f70.e37b6","type":"server-state-changed","z":"a7fe27bd.2509f8","name":"Life360 - Fletcher","server":"a3722ee8.c88ce","version":1,"entityidfilter":"device_tracker.life360_fletcher_kelly","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":120,"y":340,"wires":[["c7361d4c.1a0fd"]]},{"id":"69b1fe35.2b348","type":"debug","z":"a7fe27bd.2509f8","name":"fletcher_work","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":965,"y":160,"wires":[]},{"id":"9f372854.a64408","type":"switch","z":"a7fe27bd.2509f8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"fletcher_work","vt":"str"},{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"not_home","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":610,"y":340,"wires":[["69b1fe35.2b348"],["ae8093b3.e6b9a","d15b7cca.4448"],["5256da42.a63034"]]},{"id":"5256da42.a63034","type":"debug","z":"a7fe27bd.2509f8","name":"not_home","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":955,"y":540,"wires":[]},{"id":"ae8093b3.e6b9a","type":"debug","z":"a7fe27bd.2509f8","name":"home","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":945,"y":360,"wires":[]},{"id":"abfcdd3b.9c68c","type":"pushover","z":"a7fe27bd.2509f8","name":"","device":"","title":"fletcher_work_nodered","priority":0,"sound":"","url":"","url_title":"","html":false,"x":995,"y":120,"wires":[]},{"id":"857acace.da57f8","type":"pushover","z":"a7fe27bd.2509f8","name":"","device":"","title":"fletcher_home_nodered","priority":0,"sound":"","url":"","url_title":"","html":false,"x":1005,"y":320,"wires":[]},{"id":"c0809818.e6f5c8","type":"pushover","z":"a7fe27bd.2509f8","name":"","device":"","title":"fletcher_not_home_nodered","priority":0,"sound":"","url":"","url_title":"","html":false,"x":1015,"y":500,"wires":[]},{"id":"2b49fd6d.c19912","type":"mqtt in","z":"b9fe7189.3c263","name":"","topic":"tele/d1minikitchen/SENSOR","qos":"2","datatype":"auto","broker":"6eb36010.171f5","x":170,"y":260,"wires":[["e88e7ac2.d7d088","ea5c971d.967638"]]},{"id":"ea5c971d.967638","type":"debug","z":"b9fe7189.3c263","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":420,"y":420,"wires":[]},{"id":"e88e7ac2.d7d088","type":"json","z":"b9fe7189.3c263","name":"","property":"payload","action":"","pretty":false,"x":480,"y":240,"wires":[["ea5c971d.967638","fa3b4b4b.d85858","9830f0df.29c7b"]]},{"id":"e8c59da0.d7771","type":"mqtt out","z":"b9fe7189.3c263","name":"","topic":"tele/mxchip1/temp","qos":"","retain":"","broker":"6eb36010.171f5","x":870,"y":100,"wires":[]},{"id":"fa3b4b4b.d85858","type":"change","z":"b9fe7189.3c263","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.AM2301.Temperature","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":160,"wires":[["e8c59da0.d7771"]]},{"id":"9830f0df.29c7b","type":"change","z":"b9fe7189.3c263","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.AM2301.Humidity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":320,"wires":[["650e86e7.ececf8"]]},{"id":"650e86e7.ececf8","type":"mqtt out","z":"b9fe7189.3c263","name":"","topic":"tele/mxchip1/humidity","qos":"","retain":"","broker":"6eb36010.171f5","x":920,"y":320,"wires":[]},{"id":"ba93698d.f96ba8","type":"debug","z":"95334549.408f08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":310,"y":300,"wires":[]},{"id":"3568f6e9.3fc92a","type":"api-call-service","z":"f119fad.23edf08","name":"Alexa Dot - Fletcher is home","server":"abc5f2b.6bde21","service_domain":"media_player","service":"alexa_tts","data":"{\"entity_id\":\" media_player.fletcher_s_echo_dot\",\"message\":\"{{payload.message}}\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1080,"y":260,"wires":[[]]},{"id":"b466d11c.8ae4","type":"api-call-service","z":"f119fad.23edf08","name":"Alexa Plus - Fletcher is home","server":"abc5f2b.6bde21","service_domain":"media_player","service":"alexa_tts","data":"{\"entity_id\":\"media_player.fletcher_s_echo_plus\",\"message\":\"{{payload.message}}\"}","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1080,"y":200,"wires":[[]]},{"id":"cfc4d69d.c59ea8","type":"function","z":"f119fad.23edf08","name":"create \"fletcher\" home message","func":"var name = 'Fletcher';\n\nmsg.payload = { \n    message: name + ' is home',\n};\nmsg.topic = 'Presence Tracker'\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":220,"wires":[["b466d11c.8ae4","3568f6e9.3fc92a"]]},{"id":"1e2b2ccb.f40223","type":"switch","z":"f119fad.23edf08","name":"HOME / NOT HOME","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"not_home","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":300,"wires":[["cfc4d69d.c59ea8"],[]],"outputLabels":["Fletcher",""]},{"id":"2376b9e6.0edfc6","type":"server-state-changed","z":"f119fad.23edf08","name":"fletcher-home-devicetracker","server":"c66a5642.c17e98","version":1,"entityidfilter":"device_tracker.fletcher_s_s9","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":120,"y":200,"wires":[["1e2b2ccb.f40223","d55158cb.b5a5c8"]]},{"id":"d55158cb.b5a5c8","type":"debug","z":"f119fad.23edf08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":400,"y":140,"wires":[]},{"id":"4dc3c2a9.9b28ec","type":"secret","z":"6e4e7309.81165c","name":"secret","x":290,"y":460,"wires":[["75a3e0c8.9585b"]]},{"id":"7444290a.ae9af8","type":"http in","z":"6e4e7309.81165c","name":"","url":"/fletchertraffic","method":"get","upload":false,"swaggerDoc":"","x":110,"y":600,"wires":[["4dc3c2a9.9b28ec"]]},{"id":"5fc83e4e.e1a0a","type":"http in","z":"6e4e7309.81165c","name":"","url":"/traffic","method":"get","upload":false,"swaggerDoc":"","x":60,"y":280,"wires":[["253083b6.febbcc","4dc3c2a9.9b28ec"]]},{"id":"c7361d4c.1a0fd","type":"switch","z":"a7fe27bd.2509f8","name":"Check if state has actually changed","property":"data.old_state.state","propertyType":"msg","rules":[{"t":"neq","v":"data.new_state.state","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":380,"y":340,"wires":[["9f372854.a64408"]]},{"id":"4a3d556c.135414","type":"mqtt in","z":"d90740e8.853308","name":"D1MiniKitchen - Sensor","topic":"tele/d1minikitchen/SENSOR","qos":"0","datatype":"json","broker":"16ebb146.299d6f","x":140,"y":100,"wires":[["287e4a24.981166","78dab763.eaeac"]]},{"id":"287e4a24.981166","type":"mongodb out","z":"d90740e8.853308","mongodb":"39e7b6cc.400702","name":"","collection":"D1Mini","payonly":false,"upsert":false,"multi":false,"operation":"insert","x":630,"y":80,"wires":[]},{"id":"163d1562.ff87fb","type":"comment","z":"d90740e8.853308","name":"MQTT -> Node-Red -> InfluxDB","info":"","x":170,"y":460,"wires":[]},{"id":"13719a21.ada6e6","type":"mqtt in","z":"d90740e8.853308","name":"Temperature - MXChip Telemetry","topic":"tele/mxchip1/temp","qos":"2","datatype":"auto","broker":"16ebb146.299d6f","x":170,"y":520,"wires":[[]]},{"id":"4859cbe6.f42e5c","type":"function","z":"d90740e8.853308","name":"format for influx","func":"msg.payload ={\n    locale: \"Breakfast-Nook\",\n    temperature: parseFloat(msg.payload)\n}\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":540,"wires":[["26a945bc.32027a","b0b009f2.297258"]]},{"id":"26a945bc.32027a","type":"debug","z":"d90740e8.853308","name":"known","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":790,"y":600,"wires":[]},{"id":"b0b009f2.297258","type":"influxdb out","z":"d90740e8.853308","influxdb":"87bc6ced.c12878","name":"influx insert","measurement":"temperature","precision":"","retentionPolicy":"","x":730,"y":500,"wires":[]},{"id":"2c972e35.3f0502","type":"inject","z":"d90740e8.853308","name":"inject timestamp","topic":"","payload":"","payloadType":"date","repeat":"600","crontab":"","once":false,"onceDelay":"","x":130,"y":900,"wires":[["74073002.a1df8"]]},{"id":"74073002.a1df8","type":"http request","z":"d90740e8.853308","name":"OpenWeatherMap API","method":"GET","ret":"txt","paytoqs":false,"url":"http://api.openweathermap.org/data/2.5/weather?q=Sandton,ZA&units=metric&APPID=de570399625a54769eaa09cef49a3706","tls":"","proxy":"","x":380,"y":900,"wires":[["10e9a275.6b41de"]]},{"id":"10e9a275.6b41de","type":"json","z":"d90740e8.853308","name":"","property":"payload","action":"","pretty":true,"x":630,"y":900,"wires":[["9bf99611.2f7cb","566e0f01.fc23f"]]},{"id":"9bf99611.2f7cb","type":"function","z":"d90740e8.853308","name":"format for influx","func":"msg.payload ={\n    locale: msg.payload.name,\n    temperature: parseFloat(msg.payload.main.temp),\n    humidity: parseFloat(msg.payload.main.humidity),\n    pressure: parseFloat(msg.payload.main.pressure)\n}\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":900,"wires":[["566e0f01.fc23f","2132911.7e5976e"]]},{"id":"566e0f01.fc23f","type":"debug","z":"d90740e8.853308","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1050,"y":800,"wires":[]},{"id":"2132911.7e5976e","type":"influxdb out","z":"d90740e8.853308","influxdb":"e613cf86.3feb98","name":"influx insert","measurement":"weatherapis","precision":"","retentionPolicy":"","x":1090,"y":900,"wires":[]},{"id":"2bc95fdf.17f0e8","type":"mqtt in","z":"d90740e8.853308","name":"humidity - MXChip Telemetry","topic":"tele/mxchip1/humidity","qos":"2","datatype":"auto","broker":"16ebb146.299d6f","x":160,"y":700,"wires":[[]]},{"id":"b0ae4f85.5e312","type":"function","z":"d90740e8.853308","name":"format for influx","func":"msg.payload ={\n    locale: \"Breakfast-Nook\",\n    humidity: parseFloat(msg.payload)\n}\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":720,"wires":[["79dfe1ca.060b48","a0e4c7a7.04b47"]]},{"id":"79dfe1ca.060b48","type":"influxdb out","z":"d90740e8.853308","influxdb":"87bc6ced.c12878","name":"influx insert","measurement":"humidity","precision":"","retentionPolicy":"","x":730,"y":680,"wires":[]},{"id":"ae28c4a.bd0a838","type":"comment","z":"d90740e8.853308","name":"MQTT -> Node-Red -> mongoDB","info":"","x":610,"y":40,"wires":[]},{"id":"acd84102.4793e8","type":"debug","z":"d90740e8.853308","name":"temperature debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":470,"y":660,"wires":[]},{"id":"a0e4c7a7.04b47","type":"debug","z":"d90740e8.853308","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":700,"y":760,"wires":[]},{"id":"eb017c9a.3fa6a","type":"inject","z":"d90740e8.853308","name":"","topic":"","payload":"{\"Time\":\"2019-09-24T08:43:06\",\"DHT11\":{\"Temperature\":23,\"Humidity\":17},\"TempUnit\":\"C\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":360,"wires":[["78dab763.eaeac"]]},{"id":"3e721168.fab5d6","type":"switch","z":"109d456b.a1bf5b","name":"","property":"payload","propertyType":"msg","rules":[{"t":"jsonata_exp","v":"payload.compact.outdoor.temperature > 0","vt":"jsonata"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":120,"wires":[["fd12d0cd.43da78"]],"inputLabels":["xxx"],"outputLabels":["yyy"]},{"id":"fd12d0cd.43da78","type":"debug","z":"109d456b.a1bf5b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":570,"y":120,"wires":[]},{"id":"753adb36.28a59c","type":"comment","z":"109d456b.a1bf5b","name":"**Explanation**","info":"A JSONata Expression can be provided that will be evaluated against the whole message and will match if the expression returns a true value.","x":200,"y":60,"wires":[]},{"id":"f03e2e38.79d1c","type":"inject","z":"109d456b.a1bf5b","name":"","topic":"","payload":"{\"compact\":{\"outdoor\":{\"temperature\":15.2,\"humidity\":19,\"temperatureTrend\":\"stable\",\"battery_percent\":57,\"rf_status\":71},\"rain\":{},\"temperature\":20.7,\"temperatureTrend\":\"stable\",\"co2\":486,\"humidity\":37,\"noise\":44,\"pressure\":1026,\"pressureTrend\":\"down\",\"station_name\":\"XXX\",\"last_status_store\":1542206768},\"detailed\":[{\"_id\":\"70:ee:50:00:ea:18\",\"cipher_id\":\"XXX\",\"date_setup\":1371091374,\"last_setup\":1371091374,\"type\":\"NAMain\",\"last_status_store\":1542206768,\"module_name\":\"XXX\",\"firmware\":132,\"last_upgrade\":1440121433,\"wifi_status\":50,\"co2_calibrating\":false,\"station_name\":\"XXX\",\"data_type\":[\"Temperature\",\"CO2\",\"Humidity\",\"Noise\",\"Pressure\"],\"place\":{\"altitude\":120.08533983542,\"city\":\"XXX\",\"country\":\"US\",\"timezone\":\"XXX\",\"location\":[\"XXX\",\"XXX\"]},\"dashboard_data\":{\"time_utc\":1542206753,\"Temperature\":20.7,\"CO2\":486,\"Humidity\":37,\"Noise\":44,\"Pressure\":1026,\"AbsolutePressure\":1011.5,\"min_temp\":20.6,\"max_temp\":21.4,\"date_min_temp\":1542204365,\"date_max_temp\":1542182477,\"temp_trend\":\"stable\",\"pressure_trend\":\"down\"},\"modules\":[{\"_id\":\"02:00:00:00:f8:c4\",\"type\":\"NAModule1\",\"module_name\":\"Outdoor\",\"data_type\":[\"Temperature\",\"Humidity\"],\"last_setup\":1371091749,\"dashboard_data\":{\"time_utc\":1542206723,\"Temperature\":15.2,\"Humidity\":19,\"min_temp\":14.8,\"max_temp\":17.3,\"date_min_temp\":1542203724,\"date_max_temp\":1542189727,\"temp_trend\":\"up\"},\"firmware\":44,\"last_message\":1542206762,\"last_seen\":1542206723,\"rf_status\":71,\"battery_vp\":4965,\"battery_percent\":57}]}]}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":120,"wires":[["3e721168.fab5d6"]]},{"id":"78dab763.eaeac","type":"switch","z":"d90740e8.853308","name":"checking if temp and humidity valid","property":"payload.DHT11.Temperature","propertyType":"msg","rules":[{"t":"jsonata_exp","v":"payload.DHT11.Temperature > 0","vt":"jsonata"},{"t":"jsonata_exp","v":"payload.DHT11.Humidity > 0","vt":"jsonata"}],"checkall":"true","repair":false,"outputs":2,"x":540,"y":260,"wires":[["76f8b781.1136e"],["a4d1adec.c3da58"]]},{"id":"76f8b781.1136e","type":"function","z":"d90740e8.853308","name":"format for influx - temperature","func":"msg.payload ={\n    locale: \"Breakfast-Nook\",\n    temperature: parseFloat(msg.payload.DHT11.Temperature)\n}\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":220,"wires":[["694b35a7.79f07c","d4ee81e4.c9d4a"]]},{"id":"694b35a7.79f07c","type":"debug","z":"d90740e8.853308","name":"format","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1110,"y":240,"wires":[]},{"id":"d06c203a.84d03","type":"comment","z":"d90740e8.853308","name":"MQTT -> Node-Red -> InfluxDB","info":"","x":550,"y":220,"wires":[]},{"id":"a4d1adec.c3da58","type":"function","z":"d90740e8.853308","name":"format for influx - humidity","func":"msg.payload ={\n    locale: \"Breakfast-Nook\",\n    humidity: parseFloat(msg.payload.DHT11.Humidity)\n}\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":280,"wires":[["694b35a7.79f07c","c5802da6.2f4d98"]]},{"id":"d4ee81e4.c9d4a","type":"influxdb out","z":"d90740e8.853308","influxdb":"b08dc7ea.aabfd","name":"influx insert temp","measurement":"temperature","precision":"","retentionPolicy":"","x":1130,"y":160,"wires":[]},{"id":"c5802da6.2f4d98","type":"influxdb out","z":"d90740e8.853308","influxdb":"b08dc7ea.aabfd","name":"influx insert humidity","measurement":"humidity","precision":"","retentionPolicy":"","x":1140,"y":320,"wires":[]},{"id":"43a57be9.507d24","type":"Sonoff device","z":"91cd2d0c.f8d9","mode":"0","broker":"66726911.b76f98","device":"sonoff","name":"","onValue":"ON","offValue":"OFF","cmdPrefix":"cmnd","statPrefix":"stat","telePrefix":"tele","x":200,"y":200,"wires":[[]]},{"id":"2900ae13.95a262","type":"Sonoff device","z":"9e4fefba.e2b33","mode":"0","broker":"6eb36010.171f5","device":"sonoff-2-fibreextension","name":"test","onValue":"ON","offValue":"OFF","cmdPrefix":"cmnd","statPrefix":"stat","telePrefix":"tele","x":290,"y":100,"wires":[["dcfca3ad.c435f"]]},{"id":"c5d81940.ed2988","type":"inject","z":"9e4fefba.e2b33","name":"","topic":"","payload":"ON","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":60,"wires":[["2900ae13.95a262"]]},{"id":"dcfca3ad.c435f","type":"debug","z":"9e4fefba.e2b33","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":430,"y":140,"wires":[]},{"id":"c434a9ba.5c0b38","type":"inject","z":"9e4fefba.e2b33","name":"OFF","topic":"cmnd","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":120,"wires":[["2900ae13.95a262"]]},{"id":"474d79d7.557e68","type":"inject","z":"9e4fefba.e2b33","name":"TELE","topic":"tele","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":200,"wires":[["2900ae13.95a262"]]},{"id":"aaee3448.6126b8","type":"inject","z":"9e4fefba.e2b33","name":"STAT","topic":"stat","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":280,"wires":[["2900ae13.95a262"]]},{"id":"e255beb7.73e7e","type":"api-call-service","z":"15c157a1.27c788","name":"Alexa Plus - Fletcher is home","server":"a3722ee8.c88ce","version":1,"service_domain":"notify","service":"alexa_media","entityId":"","data":"{\"message\":\"{{payload.message}}\",\"data\":{\"type\":\"tts\"},\"target\":[\"media_player.fletcher_s_echo_dot\"]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":500,"wires":[[]]},{"id":"6cc79023.76c3e","type":"inject","z":"15c157a1.27c788","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":520,"wires":[["66a32193.c9fab","2f833142.f32dce"]]},{"id":"2f833142.f32dce","type":"function","z":"15c157a1.27c788","name":"create \"fletcher\" message","func":"var name = 'Fletcher';\n\nmsg.payload = { \n    message: name + ' is home',\n};\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":520,"wires":[["e255beb7.73e7e","8f8adaf.01b8628"]]},{"id":"80b80988.785a88","type":"api-call-service","z":"15c157a1.27c788","name":"Alexa Plus - Fletcher is home","server":"abc5f2b.6bde21","version":"1","service_domain":"media_player","service":"alexa_tts","entityId":"media_player.fletcher_s_echo_plus","data":"{\"message\":\"{{payload.message}}\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":580,"wires":[[]]},{"id":"66a32193.c9fab","type":"function","z":"15c157a1.27c788","name":"create Karien Message","func":"var name = 'Karien';\nmsg.payload = { \n    message: 'Weclome home ' + name ,\n};\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":580,"wires":[[]]},{"id":"b423f8a4.bd2348","type":"comment","z":"15c157a1.27c788","name":"Alexa testing with Home Assistant service - notify.alexa_media","info":"","x":240,"y":480,"wires":[]},{"id":"8f8adaf.01b8628","type":"api-call-service","z":"15c157a1.27c788","name":"","server":"a3722ee8.c88ce","version":1,"service_domain":"notify","service":"notify.alexa_media","entityId":"","data":"{ \"message\":\"test\", \"data\":{\"type\":\"tts\"}, \"target\":[\"media_player.fletcher_s_echo_dot\"] }","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":700,"y":420,"wires":[[]]},{"id":"aa993341.a2e07","type":"function","z":"f27aa045.98e9d","name":"create \"fletcher\" message","func":"var name = 'Fletcher';\n\nmsg.payload = { \n    message: name + ' is home',\n};\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":140,"wires":[["4055698e.897a68","6af7711e.25cf8"]]},{"id":"4055698e.897a68","type":"api-call-service","z":"f27aa045.98e9d","name":"Alexa Dot - Fletcher is home","server":"a3722ee8.c88ce","version":1,"service_domain":"notify","service":"alexa_media","entityId":"","data":"{\"message\":\"{{payload.message}}\",\"data\":{\"type\":\"tts\"},\"target\":[\"media_player.fletcher_s_echo_dot\"]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":760,"y":100,"wires":[[]]},{"id":"6af7711e.25cf8","type":"api-call-service","z":"f27aa045.98e9d","name":"Alexa Plus - Fletcher is home","server":"a3722ee8.c88ce","version":1,"service_domain":"notify","service":"alexa_media","entityId":"","data":"{\"message\":\"{{payload.message}}\",\"data\":{\"type\":\"tts\"},\"target\":[\"media_player.fletcher_s_echo_plus\"]}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":760,"y":160,"wires":[[]]},{"id":"d15b7cca.4448","type":"subflow:f27aa045.98e9d","z":"a7fe27bd.2509f8","name":"Alexa Messages","env":[],"x":980,"y":400,"wires":[]}]